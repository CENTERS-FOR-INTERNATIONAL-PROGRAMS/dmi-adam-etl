SELECT 
    mform_id::text AS mform_id,
    form_id::text AS form_id,
    case_unique_id::text AS case_unique_id,
    created_username::text AS created_username,
    created_timestamp::text AS created_timestamp,
    modified_username::text AS modified_username,
    modified_timestamp::text AS modified_timestamp,
    location_accuracy::text AS location_accuracy,
    location_latitude::text AS location_latitude,
    location_longitude::text AS location_longitude,
    syndrome::text AS syndrome,
    disease::text AS disease,
    CASE WHEN symptoms_start_date ~ '^\d{2}/\d{2}/\d{4}$' THEN to_timestamp(symptoms_start_date, 'DD/MM/YYYY')::date ELSE NULL END AS case_date,
    CASE WHEN symptoms_start_date ~ '^\d{2}/\d{2}/\d{4}$' THEN to_char(to_timestamp(symptoms_start_date, 'DD/MM/YYYY'), 'YYYY "W"IW') ELSE NULL END AS epi_week,
    epid::text AS epid,
    date_of_investigation::text AS date_of_investigation,
    location_of_investigation::text AS location_of_investigation,
    given_name::text AS given_name,
    family_name::text AS family_name,
    sex::text AS sex,
    CASE 
        WHEN age_years ~ '^[0-9]+(\.[0-9]+)?$' THEN age_years::float
        ELSE NULL
    END AS age_years,
    CASE 
        WHEN age_months ~ '^[0-9]+(\.[0-9]+)?$' THEN age_months::float
        ELSE NULL
    END AS age_months,
    CASE
        WHEN NOT (age_years ~ '^[0-9]+(\.[0-9]+)?$') THEN 'Unknown'
        WHEN age_years::float < 2 THEN '0-2 yrs'
        WHEN age_years::float BETWEEN 2 AND 5 THEN '2-5 yrs'
        WHEN age_years::float BETWEEN 5 AND 16 THEN '5-16 yrs'
        WHEN age_years::float > 16 THEN '16+ yrs'
        ELSE 'Unknown'
    END AS age_group,
    CASE WHEN date_of_birth ~ '^\d{2}/\d{2}/\d{4}$' THEN to_timestamp(date_of_birth, 'DD/MM/YYYY')::date ELSE NULL END AS date_of_birth,
    country::text AS country,
    county::text AS county,
    subcounty::text AS subcounty,
    town_village_camp::text AS town_village_camp,
    phone_number::text AS phone_number,
    occupation::text AS occupation,
    occupation_other::text AS occupation_other,
    title_residence::text AS title_residence,
    landmark::text AS landmark,
    title_parent_guardian::text AS title_parent_guardian,
    guardian_family_name::text AS guardian_family_name,
    guardian_given_name::text AS guardian_given_name,
    guardian_phone_number::text AS guardian_phone_number,
    title_respondent::text AS title_respondent,
    respondent_demographics::text AS respondent_demographics,
    respondent_family_name_demographics::text AS respondent_family_name_demographics,
    respondent_given_name_demographics::text AS respondent_given_name_demographics,
    respondent_phone_number_demographics::text AS respondent_phone_number_demographics,
    respondent_relationship_demographics::text AS respondent_relationship_demographics,
    respondent_address_demographics::text AS respondent_address_demographics,
    contact_surname::text AS contact_surname,
    contact_given_name::text AS contact_given_name,
    contact_gender::text AS contact_gender,
    contact_age::text AS contact_age,
    outcome_final_case_classification::text AS outcome_final_case_classification,
    outcome_final_patient_status::text AS outcome_final_patient_status,
    outcome_final_patient_status_other::text AS outcome_final_patient_status_other,
    outcome_reason_for_referral::text AS outcome_reason_for_referral,
    outcome_date_of_outcome::text AS outcome_date_of_outcome,
    exposure_record_exposure::text AS exposure_record_exposure,
    exposure_exposure_type::text AS exposure_exposure_type,
    exposure_food_name::text AS exposure_food_name,
    exposure_food_consumption_date::text AS exposure_food_consumption_date,
    exposure_food_source::text AS exposure_food_source,
    exposure_food_participants_count::text AS exposure_food_participants_count,
    exposure_food_affected_participants_count::text AS exposure_food_affected_participants_count,
    exposure_water_sources::text AS exposure_water_sources,
    exposure_water_sources_other::text AS exposure_water_sources_other,
    exposure_toilet_types::text AS exposure_toilet_types,
    exposure_toilet_types_other::text AS exposure_toilet_types_other,
    exposure_travel_origin_country::text AS exposure_travel_origin_country,
    exposure_travel_origin_city::text AS exposure_travel_origin_city,
    exposure_travel_departure_date::text AS exposure_travel_departure_date,
    exposure_travel_destination_country::text AS exposure_travel_destination_country,
    exposure_travel_destination_city::text AS exposure_travel_destination_city,
    exposure_travel_arrival_date::text AS exposure_travel_arrival_date,
    exposure_animal_exposure::text AS exposure_animal_exposure,
    exposure_animal_exposure_other::text AS exposure_animal_exposure_other,
    exposure_animal_species::text AS exposure_animal_species,
    exposure_animal_species_other::text AS exposure_animal_species_other,
    exposure_animal_exposure_location::text AS exposure_animal_exposure_location,
    animal_exposure_date::text AS animal_exposure_date,
    respondent::text AS respondent,
    respondent_family_name::text AS respondent_family_name,
    respondent_given_name::text AS respondent_given_name,
    respondent_phone_number::text AS respondent_phone_number,
    respondent_address::text AS respondent_address,
    respondent_relationship::text AS respondent_relationship,
    respondent_relationship_other::text AS respondent_relationship_other,
    case_seen_at_facility::text AS case_seen_at_facility,
    date_first_seen_at_facility::text AS date_first_seen_at_facility,
    admitted::text AS admitted,
    health_facility_name::text AS health_facility_name,
    admission_date::text AS admission_date,
    inpatient_number::text AS inpatient_number,
    discharge_date::text AS discharge_date,
    patient_status::text AS patient_status,
    laboratory_sample_collected::text AS laboratory_sample_collected,
    laboratory_samples_collected::text AS laboratory_samples_collected,
    laboratory_samples_collected_others::text AS laboratory_samples_collected_others,
    sample_date::text AS sample_date,
    rdt_done::text AS rdt_done,
    rdt_results::text AS rdt_results,
    samples_sent_to_laboratory::text AS samples_sent_to_laboratory,
    laboratory_name::text AS laboratory_name,
    sample_sent_to_lab_date::text AS sample_sent_to_lab_date,
    symptoms::text AS symptoms,
    symptoms_other::text AS symptoms_other,
    symptoms_unexplained_bleeding::text AS symptoms_unexplained_bleeding,
    symptoms_start_date::text AS symptoms_start_date,
    title_symptoms_start_location::text AS title_symptoms_start_location,
    symptoms_start_county::text AS symptoms_start_county,
    symptoms_start_subcounty::text AS symptoms_start_subcounty,
    symptoms_start_city_town_village_camp::text AS symptoms_start_city_town_village_camp,
    outcome::text AS outcome
FROM {{ ref('stg_viral_hemorrhagic_fever') }}
WHERE symptoms_start_date IS NOT NULL